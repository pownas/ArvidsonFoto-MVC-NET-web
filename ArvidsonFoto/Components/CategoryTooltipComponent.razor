@using ArvidsonFoto.Core.Interfaces
@using ArvidsonFoto.Core.DTOs
@inject IApiImageService ImageService
@inject IJSRuntime JS

<div class="category-tooltip-wrapper position-relative" 
     @onmouseenter="OnMouseEnter" 
     @onmouseleave="OnMouseLeave"
     @ontouchstart="OnTouchStart"
     @ontouchend="OnTouchEnd"
     @ref="tooltipElement">
    
    @ChildContent

    @if (showTooltip && imageData != null)
    {
        <div class="category-tooltip-popover @(isMobile ? "mobile" : "")" 
             style="@GetTooltipPosition()"
             @onclick:stopPropagation="true">
            <div class="popover-arrow"></div>
            <div class="popover-body p-2">
                @if (isLoading)
                {
                    <div class="text-center p-3">
                        <span class="spinner-border spinner-border-sm text-light" role="status"></span>
                        <span class="ms-2 text-light">Laddar...</span>
                    </div>
                }
                else if (imageData != null && !string.IsNullOrEmpty(imageData.UrlImage))
                {
                    <div class="category-tooltip-content">
                        <img src="@GetImagePath()" 
                             alt="@(imageData.Name ?? CategoryName ?? "Preview")" 
                             class="img-fluid rounded"
                             style="max-width: @(Config.ImageMaxWidth)px; max-height: @(Config.ImageMaxHeight)px; width: auto; height: auto; display: block;" />
                        
                        @if (!string.IsNullOrEmpty(CategoryName))
                        {
                            <div class="mt-2 fw-bold text-light">@CategoryName</div>
                        }

                        @if (imageData.DateImageTaken.HasValue)
                        {
                            <div class="mt-1 small text-white-50">
                                <i class="bi bi-camera"></i> @imageData.DateImageTaken.Value.ToString("yyyy-MM-dd")
                            </div>
                        }
                        
                        @if (ShowImageCount)
                        {
                            <div class="mt-1 small text-white-50">
                                <i class="bi bi-images"></i> Klicka för att se bilder
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted p-2">
                        <i class="bi bi-image"></i> Ingen bild tillgänglig
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public int CategoryId { get; set; }

    [Parameter]
    public string? CategoryName { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public bool ShowImageCount { get; set; } = true;

    [Parameter]
    public int DelayMs { get; set; } = 800;

    private ElementReference tooltipElement;
    private ImageDto? imageData;
    private bool showTooltip = false;
    private bool isLoading = false;
    private bool isMobile = false;
    private bool isTouchDevice = false;
    private System.Threading.Timer? hoverTimer;
    private static readonly Dictionary<int, ImageDto> ImageCache = new();

    private TooltipConfig Config { get; set; } = new()
    {
        ImageMaxWidth = 280,
        ImageMaxHeight = 200,
        ImageBaseUrl = "https://arvidsonfoto.se"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                isMobile = await JS.InvokeAsync<bool>("eval", "window.innerWidth <= 767");
                isTouchDevice = await JS.InvokeAsync<bool>("eval", "'ontouchstart' in window");
            }
            catch
            {
                // Fallback if JS is not available
                isMobile = false;
                isTouchDevice = false;
            }
        }
    }

    private async Task OnMouseEnter()
    {
        if (isTouchDevice) return; // Skip hover on touch devices
        
        hoverTimer?.Dispose();
        hoverTimer = new System.Threading.Timer(async _ => 
        {
            await InvokeAsync(async () => 
            {
                await ShowTooltipAsync();
                StateHasChanged();
            });
        }, null, DelayMs, Timeout.Infinite);
    }

    private void OnMouseLeave()
    {
        if (isTouchDevice) return;
        
        hoverTimer?.Dispose();
        showTooltip = false;
        StateHasChanged();
    }

    private async Task OnTouchStart()
    {
        if (!isTouchDevice) return;
        await ShowTooltipAsync();
    }

    private void OnTouchEnd()
    {
        if (!isTouchDevice) return;
        
        // Delay hiding to allow user to see the tooltip
        Task.Delay(2000).ContinueWith(_ => 
        {
            InvokeAsync(() => 
            {
                showTooltip = false;
                StateHasChanged();
            });
        });
    }

    private async Task ShowTooltipAsync()
    {
        showTooltip = true;
        
        if (ImageCache.TryGetValue(CategoryId, out var cachedImage))
        {
            imageData = cachedImage;
            isLoading = false;
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            await Task.Run(() =>
            {
                imageData = ImageService.GetOneImageFromCategory(CategoryId);
            });
            
            if (imageData != null)
            {
                ImageCache[CategoryId] = imageData;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to fetch image for category {CategoryId}: {ex.Message}");
            imageData = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetImagePath()
    {
        if (imageData == null || string.IsNullOrEmpty(imageData.UrlImage))
            return string.Empty;

        var imagePath = imageData.UrlImage;
        if (!imagePath.StartsWith("/"))
            imagePath = "/" + imagePath;

        return $"{Config.ImageBaseUrl}{imagePath}.thumb.jpg";
    }

    private string GetTooltipPosition()
    {
        return isMobile 
            ? "left: 50%; top: 100%; transform: translateX(-50%); margin-top: 10px;" 
            : "left: 105%; top: 0; transform: translateY(-10px);";
    }

    public void Dispose()
    {
        hoverTimer?.Dispose();
    }

    private class TooltipConfig
    {
        public int ImageMaxWidth { get; set; }
        public int ImageMaxHeight { get; set; }
        public string ImageBaseUrl { get; set; } = string.Empty;
    }
}
