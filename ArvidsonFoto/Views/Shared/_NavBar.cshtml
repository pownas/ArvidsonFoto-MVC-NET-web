@using ArvidsonFoto.Views.Shared
@using ArvidsonFoto.Core.Models
@using System.Net
@inject ArvidsonFoto.Services.ICategoryService CategoryService
@inject ArvidsonFoto.Services.IImageService ImageService

@{
    var categories = CategoryService?.GetAll() ?? new List<ArvidsonFoto.Core.Models.TblMenu>();
    
    string GetPopoverAttr(ArvidsonFoto.Core.Models.TblMenu cat, string path)
    {
        var img = ImageService.GetOneImageFromCategory(cat.MenuCategoryId ?? 0);
        if (img == null || string.IsNullOrWhiteSpace(img.ImageUrlName)) return "";
        
        var safeUrl = img.ImageUrlName.Replace("..", "").Replace("\\", "/");
        var imgUrl = $"{path}/{safeUrl}.thumb.jpg";
        var catName = WebUtility.HtmlEncode(cat.MenuDisplayName);
        var imgUrlEnc = WebUtility.HtmlEncode(imgUrl);
        var content = $"<div class='category-tooltip'><img src='{imgUrlEnc}' alt='{catName}' class='img-fluid' /><div class='category-name'>{catName}</div></div>";
        
        return $"data-bs-toggle=\"popover\" data-bs-trigger=\"hover\" data-bs-html=\"true\" data-bs-content=\"{WebUtility.HtmlEncode(content)}\" data-bs-placement=\"right\"";
    }
}

<nav class="main-nav">
    <input id="main-menu-state" type="checkbox" />
    <label class="main-menu-btn" for="main-menu-state">
        <span class="main-menu-btn-icon"></span> Växla menyns synlighet
    </label>
    <h1 class="nav-brand"><a href="./">ArvidsonFoto.se</a></h1>
    <ul id="main-menu" class="sm sm-mint">
        <li class="pe-1">
            <partial name="_NavUploadAdmin" />
        </li>
        <li class="pe-1">
            <a href="./Senast">Senast</a>
            <ul>
                <li><a href="./Senast/Fotograferad"><i class="bi bi-camera"></i> Fotograferad</a></li>
                <li><a href="./Senast/Uppladdad"><i class="bi bi-calendar-week"></i> Uppladdad</a></li>
                <li><a href="./Senast/Per%20kategori"><i class="bi bi-grid-3x3-gap"></i> Per kategori</a></li>
            </ul>
        </li>
        
        @if (categories == null || !categories.Any())
        {
            <li><a href="./Bilder/Däggdjur">Däggdjur</a><ul><li><a href="#">Dummy</a></li></ul></li>
            <li><a href="./Bilder/Fåglar">Fåglar</a><ul><li><a href="#">Dummy</a></li></ul></li>
            <li><a href="./Bilder/Insekter">Insekter</a><ul><li><a href="#">Dummy</a></li></ul></li>
        }
        else
        {
            foreach (var head in categories.Where(m => m.MenuParentCategoryId == 0 || m.MenuParentCategoryId == null))
            {
                var subs1 = categories.Where(m => m.MenuParentCategoryId == head.MenuCategoryId).OrderBy(m => m.MenuDisplayName).ToList();
                
                <li class="pe-1">
                    @if (subs1.Any())
                    {
                        if (head.MenuDisplayName == "Fåglar")
                        {
                            <a href="./Bilder/Fåglar">@head.MenuDisplayName</a>
                        }
                        else
                        {
                            <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)">@head.MenuDisplayName</a>
                        }
                        <ul>
                            @foreach (var s1 in subs1)
                            {
                                var subs2 = categories.Where(m => m.MenuParentCategoryId == s1.MenuCategoryId).OrderBy(m => m.MenuDisplayName).ToList();
                                
                                <li>
                                    @if (subs2.Any())
                                    {
                                        <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)" 
                                           class="has-category-tooltip" data-category-id="@s1.MenuCategoryId" data-category-name="@s1.MenuDisplayName">@s1.MenuDisplayName</a>
                                        <ul>
                                            @foreach (var s2 in subs2)
                                            {
                                                var subs3 = categories.Where(m => m.MenuParentCategoryId == s2.MenuCategoryId).OrderBy(m => m.MenuDisplayName).ToList();
                                                
                                                <li>
                                                    @if (subs3.Any())
                                                    {
                                                        <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s2.MenuDisplayName)" 
                                                           class="has-category-tooltip" data-category-id="@s2.MenuCategoryId" data-category-name="@s2.MenuDisplayName">@s2.MenuDisplayName</a>
                                                        <ul>
                                                            @foreach (var s3 in subs3)
                                                            {
                                                                var path3 = $"https://arvidsonfoto.se/Bilder/{SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s2.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s3.MenuDisplayName)}";
                                                                
                                                                <li>
                                                                    <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s2.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s3.MenuDisplayName)" 
                                                                       class="has-category-tooltip" data-category-id="@s3.MenuCategoryId" data-category-name="@s3.MenuDisplayName" @Html.Raw(GetPopoverAttr(s3, path3))>@s3.MenuDisplayName</a>
                                                                </li>
                                                            }
                                                        </ul>
                                                    }
                                                    else
                                                    {
                                                        var path2 = $"https://arvidsonfoto.se/Bilder/{SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s2.MenuDisplayName)}";
                                                        
                                                        <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s2.MenuDisplayName)" 
                                                           class="has-category-tooltip" data-category-id="@s2.MenuCategoryId" data-category-name="@s2.MenuDisplayName" @Html.Raw(GetPopoverAttr(s2, path2))>@s2.MenuDisplayName</a>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        var path1 = $"https://arvidsonfoto.se/Bilder/{SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)}/{SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)}";
                                        
                                        <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)/@SharedStaticFunctions.ReplaceUrlText(s1.MenuDisplayName)" 
                                           class="has-category-tooltip" data-category-id="@s1.MenuCategoryId" data-category-name="@s1.MenuDisplayName" @Html.Raw(GetPopoverAttr(s1, path1))>@s1.MenuDisplayName</a>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <a href="./Bilder/@SharedStaticFunctions.ReplaceUrlText(head.MenuDisplayName)">@head.MenuDisplayName</a>
                    }
                </li>
            }
        }
        
        <li class="pe-1">
            <a href="./Info"><i class="bi bi-info-circle"></i> Info </a>
            <ul>
                <li><a href="./Info/Kop_av_bilder"><i class="bi bi-cart3"></i> Köp av bilder</a></li>
                <li><a href="./Info/Gastbok"><i class="bi bi-book"></i> Gästbok</a></li>
                <li class="divider"></li>
                <li><a href="./Info/Kontakta"><i class="bi bi-mailbox"></i> Kontaktinformation</a></li>
                <li><a href="./Info/Om_mig"><i class="bi bi-question-circle"></i> Om mig, Torbjörn Arvidson</a></li>
                <li class="divider"></li>
                <li><a href="./Info/Sidkarta"><i class="bi bi-diagram-3"></i> Sidkarta</a></li>
                <li><a href="./Info/Copyright">&copy; Copyright</a></li>
                <partial name="_NavLoginPartial" />
            </ul>
        </li>
        <li class="pe-2"><a href="./Search" aria-label="Sök på sidan"><i class="bi bi-search"></i> Sök</a></li>
        <li class="pe-2"><a href="#" id="dark-mode-toggle" title="Tänd ljuset"><i class="bi bi-lightbulb"></i></a></li>
    </ul>
</nav>