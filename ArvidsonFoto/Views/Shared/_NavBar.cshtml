@using ArvidsonFoto.Views.Shared

<nav class="main-nav">
    <input id="main-menu-state" type="checkbox" />
    <label class="main-menu-btn" for="main-menu-state">
        <span class="main-menu-btn-icon"></span> Växla menyns synlighet
    </label>
    <h1 class="nav-brand"><a href="./">ArvidsonFoto.se</a></h1>
    <ul id="main-menu" class="sm sm-mint">
        <li class="pe-1">
            <partial name="_NavUploadAdmin" />
        </li>
        <li class="pe-1">
            <a href="./Senast">Senast</a>
            <ul>
                <li><a href="./Senast/Fotograferad"><i class="bi bi-camera"></i> Fotograferad</a></li>
                <li><a href="./Senast/Uppladdad"><i class="bi bi-calendar-week"></i> Uppladdad</a></li>
                <li><a href="./Senast/Per%20kategori"><i class="bi bi-grid-3x3-gap"></i> Per kategori</a></li>
            </ul>
        </li>
        
        @* Categories will be loaded here dynamically via JavaScript *@
        <li id="categories-loading" class="pe-1 text-muted" style="display: none;">
            <span>Laddar kategorier...</span>
        </li>
        
        <li class="pe-1">
            <a href="./Info"><i class="bi bi-info-circle"></i> Info </a>
            <ul>
                <li><a href="./Info/Kop_av_bilder"><i class="bi bi-cart3"></i> Köp av bilder</a></li>
                <li><a href="./Info/Gastbok"><i class="bi bi-book"></i> Gästbok</a></li>
                <li class="divider"></li>
                <li><a href="./Info/Kontakta"><i class="bi bi-mailbox"></i> Kontaktinformation</a></li>
                <li><a href="./Info/Om_mig"><i class="bi bi-question-circle"></i> Om mig, Torbjörn Arvidson</a></li>
                <li class="divider"></li>
                <li><a href="./Info/Sidkarta"><i class="bi bi-diagram-3"></i> Sidkarta</a></li>
                <li><a href="./Info/Copyright">&copy; Copyright</a></li>
                <partial name="_NavLoginPartial" />
            </ul>
        </li>
        <li class="pe-2"><a href="./Search" aria-label="Sök på sidan"><i class="bi bi-search"></i> Sök</a></li>
        <li class="pe-2"><a href="#" id="dark-mode-toggle" title="Tänd ljuset"><i class="bi bi-lightbulb"></i></a></li>
    </ul>
</nav>

@* Include the navigation menu cache manager *@
<script src="~/js/navigationMenuCache.js" asp-append-version="true"></script>

<script>
(function() {
    'use strict';
    
    /**
     * Sanitizes a string for use in URLs by replacing Swedish characters
     */
    function replaceUrlText(text) {
        if (!text) return '';
        return text
            .replace(/å/g, 'a').replace(/Å/g, 'A')
            .replace(/ä/g, 'a').replace(/Ä/g, 'A')
            .replace(/ö/g, 'o').replace(/Ö/g, 'O')
            .replace(/é/g, 'e').replace(/É/g, 'E')
            .replace(/ /g, '-')
            .replace(/,/g, '')
            .toLowerCase();
    }
    
    /**
     * Builds the category menu structure
     */
    function buildCategoryMenu(categories) {
        if (!categories || categories.length === 0) {
            console.warn('No categories to build menu');
            return;
        }
        
        console.log('Building menu with ' + categories.length + ' categories');
        
        // Find main categories (those with parentCategoryId === 0 or null)
        var mainCategories = categories.filter(function(cat) {
            return !cat.parentCategoryId || cat.parentCategoryId === 0;
        }).sort(function(a, b) {
            return (a.name || '').localeCompare(b.name || '');
        });
        
        var menuHtml = '';
        
        mainCategories.forEach(function(head) {
            // Find subcategories for this main category
            var subs1 = categories.filter(function(cat) {
                return cat.parentCategoryId === head.categoryId;
            }).sort(function(a, b) {
                return (a.name || '').localeCompare(b.name || '');
            });
            
            menuHtml += '<li class="pe-1">';
            
            var headUrl = head.name === 'Fåglar' ? './Bilder/Fåglar' : './Bilder/' + replaceUrlText(head.name);
            
            if (subs1.length > 0) {
                menuHtml += '<a href="' + headUrl + '">' + head.name + '</a>';
                menuHtml += '<ul>';
                
                subs1.forEach(function(s1) {
                    var subs2 = categories.filter(function(cat) {
                        return cat.parentCategoryId === s1.categoryId;
                    }).sort(function(a, b) {
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    
                    menuHtml += '<li>';
                    
                    if (subs2.length > 0) {
                        menuHtml += '<a href="./Bilder/' + replaceUrlText(head.name) + '/' + replaceUrlText(s1.name) + '" ';
                        menuHtml += 'class="has-category-tooltip" data-category-id="' + s1.categoryId + '" data-category-name="' + s1.name + '">' + s1.name + '</a>';
                        menuHtml += '<ul>';
                        
                        subs2.forEach(function(s2) {
                            var subs3 = categories.filter(function(cat) {
                                return cat.parentCategoryId === s2.categoryId;
                            }).sort(function(a, b) {
                                return (a.name || '').localeCompare(b.name || '');
                            });
                            
                            menuHtml += '<li>';
                            
                            if (subs3.length > 0) {
                                menuHtml += '<a href="./Bilder/' + replaceUrlText(head.name) + '/' + replaceUrlText(s1.name) + '/' + replaceUrlText(s2.name) + '" ';
                                menuHtml += 'class="has-category-tooltip" data-category-id="' + s2.categoryId + '" data-category-name="' + s2.name + '">' + s2.name + '</a>';
                                menuHtml += '<ul>';
                                
                                subs3.forEach(function(s3) {
                                    menuHtml += '<li>';
                                    menuHtml += '<a href="./Bilder/' + replaceUrlText(head.name) + '/' + replaceUrlText(s1.name) + '/' + replaceUrlText(s2.name) + '/' + replaceUrlText(s3.name) + '" ';
                                    menuHtml += 'class="has-category-tooltip" data-category-id="' + s3.categoryId + '" data-category-name="' + s3.name + '">' + s3.name + '</a>';
                                    menuHtml += '</li>';
                                });
                                
                                menuHtml += '</ul>';
                            } else {
                                menuHtml += '<a href="./Bilder/' + replaceUrlText(head.name) + '/' + replaceUrlText(s1.name) + '/' + replaceUrlText(s2.name) + '" ';
                                menuHtml += 'class="has-category-tooltip" data-category-id="' + s2.categoryId + '" data-category-name="' + s2.name + '">' + s2.name + '</a>';
                            }
                            
                            menuHtml += '</li>';
                        });
                        
                        menuHtml += '</ul>';
                    } else {
                        menuHtml += '<a href="./Bilder/' + replaceUrlText(head.name) + '/' + replaceUrlText(s1.name) + '" ';
                        menuHtml += 'class="has-category-tooltip" data-category-id="' + s1.categoryId + '" data-category-name="' + s1.name + '">' + s1.name + '</a>';
                    }
                    
                    menuHtml += '</li>';
                });
                
                menuHtml += '</ul>';
            } else {
                menuHtml += '<a href="' + headUrl + '">' + head.name + '</a>';
            }
            
            menuHtml += '</li>';
        });
        
        // Insert the menu HTML before the Info menu
        var infoMenu = document.querySelector('#main-menu > li:nth-last-child(3)'); // Info is 3rd from the end
        if (infoMenu) {
            infoMenu.insertAdjacentHTML('beforebegin', menuHtml);
            console.log('Menu HTML inserted successfully');
        } else {
            console.error('Could not find Info menu to insert categories');
        }
        
        // Remove loading indicator
        var loadingIndicator = document.getElementById('categories-loading');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
        
        // Reinitialize SmartMenus to recognize new items
        if (window.jQuery && jQuery.fn.smartmenus) {
            jQuery('#main-menu').smartmenus('refresh');
            console.log('SmartMenus refreshed');
        }
    }
    
    /**
     * Initialize the navigation menu
     */
    function initNavigationMenu() {
        // Show loading indicator
        var loadingIndicator = document.getElementById('categories-loading');
        if (loadingIndicator) {
            loadingIndicator.style.display = '';
        }
        
        // Get categories from cache or API
        window.NavigationMenuCache.getCategories()
            .then(function(categories) {
                buildCategoryMenu(categories);
            })
            .catch(function(error) {
                console.error('Failed to load navigation menu:', error);
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                // Show fallback minimal menu
                console.warn('Using fallback minimal menu');
            });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNavigationMenu);
    } else {
        initNavigationMenu();
    }
})();
</script>