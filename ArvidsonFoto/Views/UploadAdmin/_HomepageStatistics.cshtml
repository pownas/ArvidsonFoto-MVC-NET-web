@using ArvidsonFoto.Core.Models
@inject IImageService _imageService
@inject ICategoryService _categoryService
@inject IPageCounterService _pageCounterService
@{
    List<ArvidsonFoto.Core.Models.TblPageCounter> top10Categories = _pageCounterService.GetMonthCount(DateTime.Now.ToString("yyyy-MM"), true)
                                                              .OrderByDescending(c => c.PageViews)
                                                              .Take(10)
                                                              .ToList();
    List<ArvidsonFoto.Core.Models.TblPageCounter> monthPagesCount = _pageCounterService.GetMonthCount(DateTime.Now.ToString("yyyy-MM"), false);

    // Hämta data för de senaste 6 månaderna för grafen
    Dictionary<string, int> monthlyPageViews = _pageCounterService.GetMonthlyPageViewsChart(6, false);
    Dictionary<string, int> monthlyCategoryViews = _pageCounterService.GetMonthlyPageViewsChart(6, true);

}

<!-- Chart.js för sidvisningar per månad -->
<div class="mb-4">
    <h4>Sidvisningar senaste 6 månaderna</h4>
    <div style="width: 100%; height: 400px;">
        <canvas id="pageViewsChart"></canvas>
    </div>
</div>

<h4>Sidvisningar per sida, denna månaden (@(DateTime.Now.ToString("yyyy-MM")))</h4>
<table class="table table-striped table-dark">
    <thead>
        <tr>
            <th scope="col" class="col-3">Visningar</th>
            <th scope="col" class="col-5">Kategori</th>
            <th scope="col" class="col-4">Senast besökt</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var pageViewed in monthPagesCount)
        {
            <tr>
                <th scope="row">@pageViewed.PageViews</th>
                <td>@pageViewed.PageName</td>
                <td>@pageViewed.LastShowDate</td>
            </tr>
        }
    </tbody>
</table>

<h4>10 mest visade kategorierna, denna månaden (@(DateTime.Now.ToString("yyyy-MM")))</h4>
<table class="table table-striped table-dark">
    <thead>
        <tr>
            <th scope="col" class="col-3">Visningar</th>
            <th scope="col" class="col-5">Kategori</th>
            <th scope="col" class="col-4">Senast besökt</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var category in top10Categories)
        {
            <tr>
                <th scope="row">@category.PageViews</th>
                <td>@category.PageName</td>
                <td>@category.LastShowDate</td>
            </tr>
        }
    </tbody>
</table>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('pageViewsChart').getContext('2d');
    
    // Förbereda data för grafen
    const pageViewsData = @Html.Raw(Json.Serialize(monthlyPageViews));
    const categoryViewsData = @Html.Raw(Json.Serialize(monthlyCategoryViews));
    
    const months = Object.keys(pageViewsData);
    const pageViews = Object.values(pageViewsData);
    const categoryViews = Object.values(categoryViewsData);
    
    // Formatera månadslabels för bättre visning
    const monthLabels = months.map(month => {
        const date = new Date(month + '-01');
        return date.toLocaleDateString('sv-SE', { year: 'numeric', month: 'short' });
    });
    
    // Kontrollera om Chart.js har laddats
    if (typeof Chart !== 'undefined') {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'Sidvisningar',
                    data: pageViews,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: 'Kategorivisningar',
                    data: categoryViews,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Sidvisningar per månad (senaste 6 månaderna)'
                    },
                    legend: {
                        display: true
                    }
                }
            }
        });
    } else {
        // Fallback: visa data i tabellformat om Chart.js inte kan laddas
        const canvas = document.getElementById('pageViewsChart');
        const fallbackDiv = document.createElement('div');
        fallbackDiv.className = 'alert alert-info';
        fallbackDiv.innerHTML = `
            <h5>Månadsvis statistik (Chart.js kunde inte laddas)</h5>
            <table class="table table-sm table-striped">
                <thead>
                    <tr><th>Månad</th><th>Sidvisningar</th><th>Kategorivisningar</th></tr>
                </thead>
                <tbody>
                    ${monthLabels.map((label, i) => 
                        `<tr><td>${label}</td><td>${pageViews[i]}</td><td>${categoryViews[i]}</td></tr>`
                    ).join('')}
                </tbody>
            </table>
        `;
        canvas.parentNode.replaceChild(fallbackDiv, canvas);
    }
});
</script>