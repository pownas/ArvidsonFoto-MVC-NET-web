@*<!-- Bilder-index (Galleriet) -->*@
@model GalleryViewModel
@inject IApiImageService _imageService
@inject IApiCategoryService _categoryService
@using ArvidsonFoto.Core.Interfaces
@using ArvidsonFoto.Core.DTOs
@using System.Net

@section MetaData {
    <!-- Robots -->
    <meta name="robots" content="noimageindex, nofollow" />
    @{
        int pageImgCount = Model!.AllImagesList is not null ? Model.AllImagesList.Count : 0;
        string firstImageUrl = Model.DisplayImagesList.FirstOrDefault()?.UrlImage ?? "";
        string fullImageUrl = !string.IsNullOrEmpty(firstImageUrl) ? $"https://ArvidsonFoto.se/{firstImageUrl}.jpg" : "";
    }
    <meta name="description" content="Torbjörn Arvidson Foto - Bilder på: @ViewData["Title"]. Antal bilder: @(pageImgCount)st" />
    <link rel="canonical" href="https://ArvidsonFoto.se@(Model.CurrentUrl)" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bilder på: @ViewData["Title"] - Torbjörn Arvidson Foto">
    <meta name="twitter:description" content="Torbjörn Arvidson Foto - Bilder på: @ViewData["Title"]. Antal bilder: @(pageImgCount)st.">
    <meta name="twitter:image" content="@Html.Raw(fullImageUrl)">

    <!-- Open Graph for social media sharing -->
    <meta property="og:title" content="Bilder på: @ViewData["Title"] - Torbjörn Arvidson Foto">
    <meta name="og:description" content="Torbjörn Arvidson Foto - Bilder på: @ViewData["Title"]. Antal bilder: @(pageImgCount)st." />
    <meta property="og:image" content="@Html.Raw(fullImageUrl)">
    <meta property="og:url" content="https://ArvidsonFoto.se@(Model.CurrentUrl)">
}

@{
    List<CategoryDto> subCategories = new List<CategoryDto>();
    try
    {
        subCategories = _categoryService.GetSubsList(Model!.SelectedCategory.CategoryId ?? 0)
                                        .OrderBy(c => c.Name)
                                        .ToList();

        if (Model.SelectedCategory.Name != null && Model.SelectedCategory.Name.Length > 0 || Model.SelectedCategory is null)
        {
            ViewData["Title"] = Model.SelectedCategory!.Name;
        }
        else
        {
            ViewData["Title"] = "Ingen kategori skickades med...";
        }
    }
    catch (Exception ex)
    {
        Model!.ErrorMessage = ex.Message;
        ViewData["Title"] = "Bilder-sidan hittades inte";
    }
    
    // Helper function to get popover attributes for a category
    string GetPopoverAttributes(CategoryDto category, string imagePath)
    {
        var image = _imageService.GetOneImageFromCategory(category.CategoryId ?? 0);
        if (image == null || string.IsNullOrWhiteSpace(image.UrlImage))
        {
            return "";
        }
        
        // Extract filename from UrlImage path (e.g., "bilder/kategori/filnamn" -> "filnamn")
        string fileName = image.UrlImage.Split('/').Last();
        
        // Sanitize the image URL to prevent path traversal
        string safeImageUrl = fileName.Replace("..", "").Replace("\\", "/");
        
        string imageUrl = imagePath + "/" + safeImageUrl + ".thumb.jpg";
        
        // Build the popover content - escape the values but not the HTML structure
        string escapedCategoryName = WebUtility.HtmlEncode(category.Name);
        string escapedImageUrl = WebUtility.HtmlEncode(imageUrl);
        string popoverContent = $"<div class='category-tooltip'><img src='{escapedImageUrl}' alt='{escapedCategoryName}' class='img-fluid' /><div class='category-name'>{escapedCategoryName}</div></div>";
        
        return $"data-toggle=\"popover\" data-trigger=\"hover\" data-html=\"true\" data-content=\"{WebUtility.HtmlEncode(popoverContent)}\" data-placement=\"right\"";
    }
}
<nav id="page-breadcrumbs" aria-label="breadcrumb">
    <ol class="breadcrumb bg-dark-arvidsonfoto">
        <li class="breadcrumb-item"><a href="/">ArvidsonFoto.se</a></li>
        @{
            string[] splittUrl = Model.CurrentUrl.Split("/");
            string currentUrl = "";
            for (int i = 0; i < splittUrl.Length; i++)
            {
                if (i > 0) //Sorterar bort första punkten .
                {
                    currentUrl += "/" + splittUrl[i];
                    if (splittUrl.Length.Equals(i + 1))
                    {
                        <li class="breadcrumb-item active" aria-current="page">@splittUrl[i]</li>
                    }
                    else
                    {
                        <li class="breadcrumb-item"><a href="@currentUrl">@splittUrl[i]</a></li>
                    }
                }
            }
        }
    </ol>
</nav>

@if (Model.SelectedCategory is not null)
{
    <h2 id="CategoryId-@Model.SelectedCategory.CategoryId">@ViewData["Title"]</h2>
}
else
{
    <h2>@ViewData["Title"]</h2>

    @if(ViewData["Title"]!.Equals("Bilder-sidan hittades inte"))
    {
        Log.Fatal("Could not show the Image-URL: '" + currentUrl + "'");
    }
}

@if (subCategories is not null)
{
    <div class="categories">
    @foreach (var category in subCategories)
    {
        string imgPath = "https://arvidsonfoto.se" + Model.CurrentUrl + "/" + category.Name;
        string popoverAttrs = GetPopoverAttributes(category, imgPath);
        <a id="MenuId-@category.CategoryId" class="my-1 p-1 btn btn-light btn-outline-primary text-dark" href="@(Model.CurrentUrl + "/" + category.Name)" @Html.Raw(popoverAttrs)>@category.Name</a>
    }
    </div>
}


@if (Model.TotalPages > 1)
{
    <partial name="_PageCounter" model="Model" />
}
else
{
    if (Model.AllImagesList.Count > 12)
    {
        <p id="page-image-counter-top" class="text-center">Antal bilder: @(Model.AllImagesList.Count)st , sida: @Model.CurrentPage av @Model.TotalPages</p>
    }
}

<partial name="_Gallery" model="Model" />

@if (Model.TotalPages > 1)
{
    <partial name="_PageCounter" model="Model" />
}
else
{
    if (Model.AllImagesList.Count > 0)
    {
        <p id="page-image-counter-bottom" class="text-center">Antal bilder: @(Model.AllImagesList.Count)st , sida: @Model.CurrentPage av @Model.TotalPages</p>
    }
}